<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Golf Course Mapper</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
    <style>
        html,
        body {
            height: 100%;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
        }

        .container {
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        .input-container {
            display: flex;
            flex-direction: row;
            width: 100%;
            margin: 10px auto;
            padding: 10px;
            box-sizing: border-box;
        }

        /* Style each input and button to scale properly */
        .input-container input[type="text"],
        .input-container button {
            width: 100%;
            padding: 10px;
            margin: 5px 0;
            font-size: 16px;
            border-radius: 5px;
            box-sizing: border-box;
        }

        .input-container button {
            background-color: #007bff;
            color: white;
            border: none;
            cursor: pointer;
            font-size: 16px;
        }

        .input-container button:hover {
            background-color: #0056b3;
        }

        /* Make the map fill remaining space */
        #map {
            flex-grow: 1;
            /* Allows the map to take up the remaining space */
        }

        /* Responsive adjustments for small screens */
        @media (max-width: 1200px) {
            .input-container {
                display: flex;
                flex-direction: column;
                max-width: 90%;
                padding: 5px;
            }

            .input-container input[type="text"],
            .input-container button {
                padding: 8px;
                font-size: 14px;
            }
        }


        .hole-number {
            background-color: yellow;
            /* Change background color for visibility */
            border: 2px solid green;
            /* Make the border more pronounced */
            border-radius: 5px;
            padding: 5px;
            /* Increase padding */
            text-align: center;
            font-size: 14px;
            /* Adjust font size */
            color: black;
            /* Ensure text is dark */
        }
    </style>
</head>

<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />

<body>
    <div class="container">
        <form id="controls" class="input-container" onsubmit="findGolfCourse(); return false;">
            <input type="text" id="courseName" placeholder="Enter golf course name (or leave empty)"
                value="China Creek">
            <input type="text" id="location" placeholder="Enter city, zipcode, or use map view" value="98006">
            <button type="submit">Go</button>
        </form>
        <div id="map"></div>
    </div>


    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
    <script>
        // Initialize map
        const map = L.map('map').setView([47.6104, -122.2007], 13);
        map.on('locationfound', onLocationFound);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 18,
            tileSize: 256
        }).addTo(map);

        // Initialize geocoder for location input
        const geocoder = L.Control.Geocoder.nominatim();

        async function findGolfCourse() {
            const courseName = document.getElementById("courseName").value;
            const location = document.getElementById("location").value;
            // Clear previous layers
            map.eachLayer((layer) => {
                if (!!layer.toGeoJSON) map.removeLayer(layer);
            });

            map.locate();
            if (location) {
                // Use geocoding to convert location input into bounding box
                await geocoder.geocode(location, (results) => queryForGolfCourses(results, courseName));
            }
        }

        function queryForGolfCourses(results, courseName) {
            if (results.length > 0) {
                const result = results[0];
                const bbox = result.bbox;
                const south = bbox.getSouthWest().lat;
                const west = bbox.getSouthWest().lng;
                const north = bbox.getNorthEast().lat;
                const east = bbox.getNorthEast().lng;

                L.rectangle(bbox, {
                    color: "#ff7800",   // Border color
                    weight: 1,          // Border weight
                    fillOpacity: 0      // No fill color
                }).addTo(map);


                // Construct Overpass API query

                var overpassQuery = '';
                if (courseName.length === 0) {
                    overpassQuery = `
                        [out:json];
                        nwr["golf"="hole"](${south},${west},${north},${east});
                        // way(r)["golf"="fairway"];
                        // way(r)["golf"="green"];
                        out body;
                        >;
                        out skel qt;
                    `;
                } else {
                    overpassQuery = `
                        [out:json];
                        nwr["golf:course:name"="${courseName}"](${south},${west},${north},${east});
                        out body;
                        >;
                        out skel qt;
                    `;
                }

                // Fetch Overpass API results
                fetch(`https://overpass-api.de/api/interpreter?data=${encodeURIComponent(overpassQuery)}`)
                    .then(response => response.json())
                    .then(data => displayGolfCourse(data, bbox))
                    .catch(error => console.error("Overpass API error:", error));
            } else {
                alert("Location not found.");
            }
        }

        function convertLocationToObjectWithBBox(position, bboxSize = 0.05) {

            const lat = position.latitude;
            const lng = position.longitude;

            const locationWithBBox = {
                bbox:
                    L.latLngBounds(
                        [lat - bboxSize, lng - bboxSize],
                        [lat + bboxSize, lng + bboxSize]
                    )
            };

            return locationWithBBox;
        }

        function getCurrentLocation() {
            return new Promise((resolve, reject) => {
                navigator.geolocation.getCurrentPosition(
                    position => resolve(position),
                    error => reject(error)
                );
            });
        }

        function displayGolfCourse(data, bounds) {


            // Create a node lookup table from all nodes in the response
            const nodeLookup = {};
            data.elements.forEach((element) => {
                if (element.type === "node") {
                    nodeLookup[element.id] = [element.lon, element.lat];
                }
            });

            // Display fetched data on the map
            const fairways = L.geoJSON(null, { style: { color: "green" } }).addTo(map);
            const greens = L.geoJSON(null, { style: { color: "darkgreen", fillOpacity: 0.4 } }).addTo(map);

            // Array to hold all coordinates for bounding box calculation
            const allCoordinates = [];

            data.elements.forEach((element) => {
                if (element.type === "node") return;
                const geojson = toGeoJSON(element, nodeLookup);
                if (element.tags["golf"] === "hole") {
                    fairways.addData(geojson);
                    // Add hole number overlay
                    const holeNumber = element.tags["ref"]; // Adjust based on the correct tag
                    if (holeNumber) {
                        const midpoint = getMidpoint(geojson.geometry.coordinates);
                        const marker = L.marker(midpoint, {
                            icon: L.divIcon({
                                className: 'hole-number',
                                html: holeNumber,
                                iconSize: [15, 15]
                            })
                        }).addTo(map);
                    }
                } else if (element.tags["golf"] === "green") {
                    greens.addData(geojson);
                }

                // Collect all coordinates for bounding box calculation
                geojson.geometry.coordinates.forEach(coord => {
                    allCoordinates.push(coord);
                });
            });

            // Calculate bounding box from all collected coordinates
            if (allCoordinates.length > 0) {
                const bounds = L.latLngBounds(allCoordinates.map(coord => [coord[1], coord[0]]));
                map.fitBounds(bounds);
                // map.locate();
            } else {
                alert("No ways found for the specified course.");
            }
        }

        function toGeoJSON(element, nodeLookup) {
            if (element.type === "way") {
                const coordinates = element.nodes
                    .map(nodeId => nodeLookup[nodeId]) // Map node IDs to [lon, lat] pairs
                    .filter(coord => coord); // Filter out any undefined entries

                // Only create a geoJSON object if we have valid coordinates
                if (coordinates.length > 0) {
                    return {
                        type: "Feature",
                        geometry: {
                            type: "LineString",
                            coordinates: coordinates
                        },
                        properties: element.tags
                    };
                }
            }
            return null; // Return null for unsupported types
        }

        // Helper function to get the midpoint of a line
        function getMidpoint(coordinates) {
            // const midIndex = Math.floor(coordinates.length / 2);
            return [coordinates[coordinates.length - 1][1], coordinates[coordinates.length - 1][0]]; // [lng, lat]
        }

        function onLocationFound(e) {
            // console.log("location found!", e);
            const location = document.getElementById("location").value;
            const courseName = document.getElementById("courseName").value;
            if (!location) {
                queryForGolfCourses([convertLocationToObjectWithBBox(e, 0.1)], courseName);
            }
            var radius = e.accuracy;

            L.marker(e.latlng).addTo(map)
                .bindPopup("You are within " + radius + " meters from this point").openPopup();

            L.circle(e.latlng, radius).addTo(map);
        }

    </script>
</body>

</html>
